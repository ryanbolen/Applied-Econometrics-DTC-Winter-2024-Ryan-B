---
author: "Ryan Bolen"
title: "Clean Data"
format: 
  docx: 
    echo: true
    message: false
editor: visual
---

## Libraries

In the following code chunk, load all the libraries you will need:

```{r}
library(tidyverse)
library(fixest)
library(rio)
library(lubridate)


```

```{r}
# Getting all trends up to files in a list to pass to import/merge.

trends_up_to_list <- list.files(pattern = 'trends_up_to_')

```

```{r}
trends_up_to <- import_list(trends_up_to_list,rbind = TRUE, fill = TRUE)
```

```{r}
# Get the first ten characters out of the month or week column which at the moment is a string. 

# Change the date string to an actual date and then floor it to the first day of the month.

trends_up_to <- trends_up_to %>% 
  mutate(monthorweek2 = str_sub(monthorweek,end = 10)) %>% 
  mutate(monthorweek2 = ymd(monthorweek2)) %>% 
  mutate(first_day_of_month = floor_date(monthorweek2,unit= 'month'))



```

```{r}

# Standardize the index variable by school name

trends_up_to <- trends_up_to %>% group_by(schname,keyword) %>% mutate(std_key = (index -mean(index,na.rm = TRUE))/sd(index,na.rm = TRUE))
```

```{r}

# Summarize to school name and month level

trends_up_to <- trends_up_to %>% group_by(first_day_of_month,schname) %>% summarize(tot = sum(std_key))
```

```{r}

# Read in the scorecard data

SC <- import('Most+Recent+Cohorts+(Scorecard+Elements).csv')

# Read in the id name link data

id_name_link <- import('id_name_link.csv')
```

```{r}
# count how many times each school name pops up in id_name_link filter out any rows where n > 1

id_name_link <- id_name_link %>% group_by(schname) %>% mutate(n = n()) %>% filter(n == 1)

```

```{r}
# Merge data sets - inner join trends up to (D2) on id_name_link that we summarised.

trends_up_to <- trends_up_to %>% inner_join(id_name_link, join_by(schname)) 

SC <- SC %>% mutate(opeid = OPEID)

clean_data <- trends_up_to %>% inner_join(SC, join_by(opeid))


```

```{r}
# Need to look at data before September 2015 (before card was released) and after September 2015 (after it was released)

# Vars that might be good to control for:

# Admission Rate 'ADM_RATE'
# Percentage of students who are financially independent 'DEP_STAT_PCT_IND'
# 

# Dependent Variable of choice
# Mean earnings of students working and not enrolled 8 years after entry 'mn_earn_wne_p8'
```

```{r}

# Getting frame with only colleges that grant bachelor's degrees using PREDDEG variable equal to 3

bach_degree_school_data <- clean_data %>% filter(PREDDEG == 3)


```
